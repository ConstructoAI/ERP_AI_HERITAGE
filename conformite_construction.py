import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import json
from typing import Dict, List, Optional, Tuple
import re

class ConformiteConstruction:
    """Module de gestion de la conformit√© pour la construction au Qu√©bec"""
    
    def __init__(self, db_manager):
        self.db = db_manager
        self.categories_rbq = {
            "1.1": "Entrepreneur en b√¢timents r√©sidentiels neufs classe I",
            "1.2": "Entrepreneur en b√¢timents r√©sidentiels neufs classe II", 
            "1.3": "Entrepreneur en petits b√¢timents",
            "2": "Entrepreneur en syst√®mes de chauffage √† air chaud",
            "3": "Entrepreneur en plomberie",
            "4": "Entrepreneur en √©lectricit√©",
            "5.1": "Entrepreneur en excavation et terrassement",
            "5.2": "Entrepreneur en fondations profondes",
            "6": "Entrepreneur en charpente et menuiserie",
            "7": "Entrepreneur en rev√™tements ext√©rieurs",
            "8": "Entrepreneur en syst√®mes int√©rieurs",
            "9": "Entrepreneur en toitures",
            "10": "Entrepreneur en isolation, √©tanch√©it√©, couvertures et rev√™tements m√©talliques",
            "11.1": "Entrepreneur en structures de b√©ton",
            "11.2": "Entrepreneur en b√©ton pr√©fabriqu√©",
            "12": "Entrepreneur en armature et ferraillage",
            "13": "Entrepreneur en structures m√©talliques et √©l√©ments pr√©fabriqu√©s",
            "14": "Entrepreneur en ma√ßonnerie",
            "15.1": "Entrepreneur en syst√®mes de chauffage √† eau chaude",
            "15.2": "Entrepreneur en syst√®mes de chauffage √† vapeur",
            "15.3": "Entrepreneur en syst√®mes de br√ªleurs au mazout",
            "15.4": "Entrepreneur en syst√®mes de br√ªleurs au gaz",
            "15.5": "Entrepreneur en ventilation",
            "15.6": "Entrepreneur en climatisation",
            "15.7": "Entrepreneur en r√©frig√©ration",
            "15.8": "Entrepreneur en protection-incendie",
            "16": "Entrepreneur g√©n√©ral"
        }
        
        self.metiers_ccq = {
            "Apprenti": ["1re p√©riode", "2e p√©riode", "3e p√©riode", "4e p√©riode"],
            "Briqueteur-ma√ßon": "Compagnon",
            "Calorifugeur": "Compagnon",
            "Carreleur": "Compagnon",
            "Charpentier-menuisier": "Compagnon",
            "Chaudronnier": "Compagnon",
            "Cimentier-applicateur": "Compagnon",
            "Couvreur": "Compagnon",
            "√âlectricien": "Compagnon",
            "Ferblantier": "Compagnon",
            "Ferrailleur": "Compagnon",
            "Frigoriste": "Compagnon",
            "Grutier": ["Classe 1", "Classe 2", "Classe 3", "Classe 4"],
            "M√©canicien d'ascenseur": "Compagnon",
            "M√©canicien de chantier": "Compagnon",
            "M√©canicien en protection-incendie": "Compagnon",
            "Monteur-assembleur": "Compagnon",
            "Monteur-m√©canicien (vitrier)": "Compagnon",
            "Op√©rateur d'√©quipement lourd": ["Classe 1", "Classe 2", "Classe 3", "Classe 4"],
            "Op√©rateur de pelles m√©caniques": "Compagnon",
            "Peintre": "Compagnon",
            "Pl√¢trier": "Compagnon",
            "Plombier": "Compagnon",
            "Poseur de rev√™tements souples": "Compagnon",
            "Poseur de syst√®mes int√©rieurs": "Compagnon",
            "Soudeur": ["Classe A", "Classe B", "Classe C"],
            "Soudeur en tuyauterie": ["Classe A", "Classe B"],
            "Tuyauteur": "Compagnon"
        }

    def afficher_interface(self):
        """Interface principale du module de conformit√©"""
        st.title("üèóÔ∏è Gestion de la Conformit√© Construction")
        
        tab1, tab2, tab3, tab4, tab5 = st.tabs([
            "üé´ Licences RBQ", 
            "üë∑ Cartes CCQ",
            "üìã Attestations",
            "üîç V√©rifications",
            "üìä Tableau de bord"
        ])
        
        with tab1:
            self.gestion_licences_rbq()
            
        with tab2:
            self.gestion_cartes_ccq()
            
        with tab3:
            self.gestion_attestations()
            
        with tab4:
            self.verifications_conformite()
            
        with tab5:
            self.tableau_bord_conformite()
    
    def gestion_licences_rbq(self):
        """Gestion des licences RBQ"""
        st.header("Gestion des Licences RBQ")
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            # Formulaire d'ajout/modification
            with st.form("form_licence_rbq"):
                st.subheader("Ajouter/Modifier une licence RBQ")
                
                numero_licence = st.text_input("Num√©ro de licence RBQ", 
                    help="Format: XXXX-XXXX-XX")
                
                nom_entreprise = st.text_input("Nom de l'entreprise")
                
                # S√©lection multiple des cat√©gories
                categories_selectionnees = st.multiselect(
                    "Cat√©gories de licence",
                    options=list(self.categories_rbq.keys()),
                    format_func=lambda x: f"{x} - {self.categories_rbq[x]}"
                )
                
                col_dates = st.columns(2)
                with col_dates[0]:
                    date_emission = st.date_input("Date d'√©mission")
                with col_dates[1]:
                    date_expiration = st.date_input("Date d'expiration")
                
                statut = st.selectbox("Statut", ["Active", "Suspendue", "Expir√©e"])
                
                cautionnement = st.number_input("Montant du cautionnement ($)", 
                    min_value=0.0, format="%.2f")
                
                assurance_resp = st.number_input("Assurance responsabilit√© ($)", 
                    min_value=0.0, format="%.2f")
                
                submitted = st.form_submit_button("Enregistrer")
                
                if submitted and numero_licence:
                    licence_data = {
                        "numero_licence": numero_licence,
                        "nom_entreprise": nom_entreprise,
                        "categories": json.dumps(categories_selectionnees),
                        "date_emission": date_emission.isoformat(),
                        "date_expiration": date_expiration.isoformat(),
                        "statut": statut,
                        "cautionnement": cautionnement,
                        "assurance_responsabilite": assurance_resp
                    }
                    
                    # Enregistrer dans la base de donn√©es
                    if self.db.ajouter_licence_rbq(licence_data):
                        st.success("‚úÖ Licence RBQ enregistr√©e avec succ√®s!")
                    else:
                        st.error("‚ùå Erreur lors de l'enregistrement")
        
        with col2:
            # Alertes et statistiques
            st.subheader("üìä Aper√ßu")
            
            # Alertes d'expiration
            licences_expirant = self.verifier_expirations_rbq()
            if licences_expirant:
                st.warning(f"‚ö†Ô∏è {len(licences_expirant)} licence(s) expirant dans 60 jours")
                with st.expander("Voir les d√©tails"):
                    for licence in licences_expirant:
                        st.write(f"- {licence['numero']} - Expire le {licence['expiration']}")
            
            # Statistiques
            stats = self.obtenir_stats_rbq()
            if stats:
                st.metric("Licences actives", stats.get("actives", 0))
                st.metric("Total cat√©gories", stats.get("total_categories", 0))
                st.metric("Cautionnement total", f"${stats.get('cautionnement_total', 0):,.2f}")
        
        # Liste des licences
        st.subheader("üìã Liste des licences RBQ")
        
        # Filtres
        col_filtres = st.columns(4)
        with col_filtres[0]:
            filtre_statut = st.selectbox("Filtrer par statut", 
                ["Tous", "Active", "Suspendue", "Expir√©e"])
        with col_filtres[1]:
            filtre_categorie = st.selectbox("Filtrer par cat√©gorie",
                ["Toutes"] + list(self.categories_rbq.keys()))
        
        # Affichage de la liste
        licences = self.obtenir_licences_rbq(filtre_statut, filtre_categorie)
        if licences:
            df_licences = pd.DataFrame(licences)
            st.dataframe(df_licences, use_container_width=True)
        else:
            st.info("Aucune licence RBQ enregistr√©e")
    
    def gestion_cartes_ccq(self):
        """Gestion des cartes de comp√©tence CCQ"""
        st.header("Gestion des Cartes CCQ")
        
        # S√©lection de l'employ√©
        employees = self.db.get_all_employees()
        employee_dict = {f"{emp['nom']} {emp['prenom']}": emp['id'] for emp in employees}
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            with st.form("form_carte_ccq"):
                st.subheader("Ajouter/Modifier une carte CCQ")
                
                employee_name = st.selectbox("Employ√©", 
                    options=list(employee_dict.keys()))
                employee_id = employee_dict.get(employee_name)
                
                numero_carte = st.text_input("Num√©ro de carte CCQ")
                
                # M√©tiers et qualifications
                metier_principal = st.selectbox("M√©tier principal",
                    options=list(self.metiers_ccq.keys()))
                
                if metier_principal:
                    qualifications = self.metiers_ccq[metier_principal]
                    if isinstance(qualifications, list):
                        qualification = st.selectbox("Qualification", qualifications)
                    else:
                        qualification = qualifications
                        st.info(f"Qualification: {qualification}")
                
                metiers_additionnels = st.multiselect(
                    "M√©tiers additionnels",
                    options=[m for m in self.metiers_ccq.keys() if m != metier_principal]
                )
                
                heures_totales = st.number_input("Heures totales accumul√©es", 
                    min_value=0, step=100)
                
                col_dates = st.columns(2)
                with col_dates[0]:
                    date_emission = st.date_input("Date d'√©mission")
                with col_dates[1]:
                    date_renouvellement = st.date_input("Date de renouvellement")
                
                asp_construction = st.checkbox("Formation ASP Construction valide")
                
                submitted = st.form_submit_button("Enregistrer")
                
                if submitted and numero_carte and employee_id:
                    carte_data = {
                        "employee_id": employee_id,
                        "numero_carte": numero_carte,
                        "metier_principal": metier_principal,
                        "qualification": qualification,
                        "metiers_additionnels": json.dumps(metiers_additionnels),
                        "heures_totales": heures_totales,
                        "date_emission": date_emission.isoformat(),
                        "date_renouvellement": date_renouvellement.isoformat(),
                        "asp_construction": asp_construction
                    }
                    
                    if self.db.ajouter_carte_ccq(carte_data):
                        st.success("‚úÖ Carte CCQ enregistr√©e avec succ√®s!")
                    else:
                        st.error("‚ùå Erreur lors de l'enregistrement")
        
        with col2:
            st.subheader("üìä Statistiques CCQ")
            
            stats_ccq = self.obtenir_stats_ccq()
            if stats_ccq:
                st.metric("Cartes actives", stats_ccq.get("cartes_actives", 0))
                st.metric("Total m√©tiers", stats_ccq.get("total_metiers", 0))
                st.metric("Heures moyennes", f"{stats_ccq.get('heures_moyennes', 0):,.0f}")
                
                # R√©partition par m√©tier
                if stats_ccq.get("repartition_metiers"):
                    st.subheader("R√©partition par m√©tier")
                    for metier, count in stats_ccq["repartition_metiers"].items():
                        st.write(f"- {metier}: {count}")
        
        # Liste des cartes CCQ
        st.subheader("üìã Liste des cartes CCQ")
        
        cartes = self.obtenir_cartes_ccq()
        if cartes:
            df_cartes = pd.DataFrame(cartes)
            st.dataframe(df_cartes, use_container_width=True)
        else:
            st.info("Aucune carte CCQ enregistr√©e")
    
    def gestion_attestations(self):
        """Gestion des attestations fiscales et autres documents"""
        st.header("Gestion des Attestations")
        
        types_attestations = {
            "Revenu Qu√©bec": "Attestation de Revenu Qu√©bec",
            "ARC": "Attestation de l'Agence du revenu du Canada",
            "CNESST": "Attestation de conformit√© CNESST",
            "CCQ": "Attestation CCQ - √âtat de situation",
            "RBQ": "Attestation de solvabilit√© RBQ"
        }
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            with st.form("form_attestation"):
                st.subheader("Ajouter une attestation")
                
                type_attestation = st.selectbox("Type d'attestation",
                    options=list(types_attestations.keys()))
                
                numero_attestation = st.text_input("Num√©ro d'attestation")
                
                col_dates = st.columns(2)
                with col_dates[0]:
                    date_emission = st.date_input("Date d'√©mission")
                with col_dates[1]:
                    date_expiration = st.date_input("Date d'expiration")
                
                statut = st.selectbox("Statut", ["Valide", "Expir√©e", "En renouvellement"])
                
                notes = st.text_area("Notes")
                
                fichier = st.file_uploader("Joindre le document (PDF)", type=['pdf'])
                
                submitted = st.form_submit_button("Enregistrer")
                
                if submitted and numero_attestation:
                    attestation_data = {
                        "type": type_attestation,
                        "numero": numero_attestation,
                        "date_emission": date_emission.isoformat(),
                        "date_expiration": date_expiration.isoformat(),
                        "statut": statut,
                        "notes": notes
                    }
                    
                    if self.db.ajouter_attestation(attestation_data):
                        st.success("‚úÖ Attestation enregistr√©e avec succ√®s!")
                        
                        # Sauvegarder le fichier si fourni
                        if fichier:
                            # Code pour sauvegarder le fichier
                            pass
                    else:
                        st.error("‚ùå Erreur lors de l'enregistrement")
        
        with col2:
            st.subheader("‚ö†Ô∏è Alertes")
            
            # V√©rifier les attestations expir√©es ou expirant bient√¥t
            alertes = self.verifier_attestations_expiration()
            
            if alertes["expirees"]:
                st.error(f"üî¥ {len(alertes['expirees'])} attestation(s) expir√©e(s)")
                with st.expander("Voir les d√©tails"):
                    for att in alertes["expirees"]:
                        st.write(f"- {att['type']}: {att['numero']}")
            
            if alertes["expirant_bientot"]:
                st.warning(f"üü° {len(alertes['expirant_bientot'])} attestation(s) expirant dans 30 jours")
                with st.expander("Voir les d√©tails"):
                    for att in alertes["expirant_bientot"]:
                        st.write(f"- {att['type']}: {att['numero']} (expire le {att['expiration']})")
        
        # Liste des attestations
        st.subheader("üìã Liste des attestations")
        
        attestations = self.obtenir_attestations()
        if attestations:
            df_attestations = pd.DataFrame(attestations)
            
            # Colorer selon le statut
            def color_status(val):
                if val == "Valide":
                    return 'background-color: #90EE90'
                elif val == "Expir√©e":
                    return 'background-color: #FFB6C1'
                else:
                    return 'background-color: #FFFFE0'
            
            styled_df = df_attestations.style.applymap(
                color_status, subset=['statut']
            )
            
            st.dataframe(styled_df, use_container_width=True)
        else:
            st.info("Aucune attestation enregistr√©e")
    
    def verifications_conformite(self):
        """Interface de v√©rification rapide de conformit√©"""
        st.header("V√©rifications de Conformit√©")
        
        # V√©rification pour nouveau projet
        st.subheader("üèóÔ∏è V√©rification pour nouveau projet")
        
        with st.form("verif_projet"):
            type_projet = st.selectbox("Type de projet",
                ["R√©sidentiel unifamilial", "Multi-logements", "Commercial", "Industriel"])
            
            valeur_projet = st.number_input("Valeur estim√©e du projet ($)", 
                min_value=0.0, format="%.2f")
            
            ville = st.text_input("Ville du projet")
            
            verifier = st.form_submit_button("V√©rifier la conformit√©")
            
            if verifier:
                resultats = self.verifier_conformite_projet(type_projet, valeur_projet, ville)
                
                if resultats["conforme"]:
                    st.success("‚úÖ Conformit√© v√©rifi√©e - Pr√™t √† soumissionner")
                else:
                    st.error("‚ùå Non-conformit√© d√©tect√©e")
                    
                with st.expander("D√©tails de la v√©rification"):
                    for item in resultats["details"]:
                        if item["status"] == "OK":
                            st.write(f"‚úÖ {item['element']}: {item['message']}")
                        else:
                            st.write(f"‚ùå {item['element']}: {item['message']}")
        
        # V√©rification d'un sous-traitant
        st.subheader("üë∑ V√©rification de sous-traitant")
        
        with st.form("verif_sous_traitant"):
            nom_entreprise = st.text_input("Nom de l'entreprise")
            numero_rbq = st.text_input("Num√©ro RBQ")
            categories_requises = st.multiselect(
                "Cat√©gories RBQ requises",
                options=list(self.categories_rbq.keys()),
                format_func=lambda x: f"{x} - {self.categories_rbq[x]}"
            )
            
            verifier_st = st.form_submit_button("V√©rifier")
            
            if verifier_st and numero_rbq:
                # Simuler une v√©rification
                st.info("üîç V√©rification en cours...")
                
                # Dans un cas r√©el, on ferait une requ√™te API ou base de donn√©es
                st.success(f"‚úÖ Entreprise {nom_entreprise} v√©rifi√©e")
                st.write("- Licence RBQ valide")
                st.write("- Cat√©gories confirm√©es")
                st.write("- Attestations √† jour")
    
    def tableau_bord_conformite(self):
        """Tableau de bord global de conformit√©"""
        st.header("Tableau de Bord de Conformit√©")
        
        # M√©triques principales
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            licences_actives = self.compter_licences_actives()
            st.metric("Licences RBQ actives", licences_actives)
        
        with col2:
            cartes_valides = self.compter_cartes_valides()
            st.metric("Cartes CCQ valides", cartes_valides)
        
        with col3:
            attestations_valides = self.compter_attestations_valides()
            st.metric("Attestations valides", attestations_valides)
        
        with col4:
            score_conformite = self.calculer_score_conformite()
            st.metric("Score de conformit√©", f"{score_conformite}%")
        
        # Graphiques
        col_graph1, col_graph2 = st.columns(2)
        
        with col_graph1:
            st.subheader("üìä Statut des documents")
            # Ici on pourrait ajouter un graphique en camembert
            # montrant la r√©partition des documents valides/expir√©s/expirant
        
        with col_graph2:
            st.subheader("üìà √âvolution de la conformit√©")
            # Ici on pourrait ajouter un graphique lin√©aire
            # montrant l'√©volution du score de conformit√© dans le temps
        
        # Alertes importantes
        st.subheader("‚ö†Ô∏è Alertes et actions requises")
        
        alertes = self.obtenir_toutes_alertes()
        
        if alertes:
            for alerte in alertes:
                if alerte["priorite"] == "haute":
                    st.error(f"üî¥ {alerte['message']}")
                elif alerte["priorite"] == "moyenne":
                    st.warning(f"üü° {alerte['message']}")
                else:
                    st.info(f"üîµ {alerte['message']}")
        else:
            st.success("‚úÖ Aucune alerte - Tous les documents sont √† jour")
        
        # Calendrier des renouvellements
        st.subheader("üìÖ Prochains renouvellements")
        
        renouvellements = self.obtenir_prochains_renouvellements()
        if renouvellements:
            df_renouv = pd.DataFrame(renouvellements)
            st.dataframe(df_renouv, use_container_width=True)
        else:
            st.info("Aucun renouvellement pr√©vu dans les 90 prochains jours")
    
    # M√©thodes utilitaires
    def verifier_expirations_rbq(self) -> List[Dict]:
        """V√©rifie les licences RBQ expirant dans les 60 jours"""
        # Simulation - √Ä remplacer par requ√™te DB
        return []
    
    def obtenir_stats_rbq(self) -> Dict:
        """Obtient les statistiques des licences RBQ"""
        # Simulation - √Ä remplacer par requ√™te DB
        return {
            "actives": 1,
            "total_categories": 3,
            "cautionnement_total": 50000.0
        }
    
    def obtenir_licences_rbq(self, filtre_statut: str, filtre_categorie: str) -> List[Dict]:
        """Obtient la liste des licences RBQ avec filtres"""
        # Simulation - √Ä remplacer par requ√™te DB
        return []
    
    def obtenir_stats_ccq(self) -> Dict:
        """Obtient les statistiques des cartes CCQ"""
        # Simulation - √Ä remplacer par requ√™te DB
        return {
            "cartes_actives": 15,
            "total_metiers": 8,
            "heures_moyennes": 5600,
            "repartition_metiers": {
                "Charpentier-menuisier": 5,
                "√âlectricien": 3,
                "Plombier": 2,
                "Autres": 5
            }
        }
    
    def obtenir_cartes_ccq(self) -> List[Dict]:
        """Obtient la liste des cartes CCQ"""
        # Simulation - √Ä remplacer par requ√™te DB
        return []
    
    def verifier_attestations_expiration(self) -> Dict:
        """V√©rifie les attestations expir√©es ou expirant bient√¥t"""
        # Simulation - √Ä remplacer par requ√™te DB
        return {
            "expirees": [],
            "expirant_bientot": []
        }
    
    def obtenir_attestations(self) -> List[Dict]:
        """Obtient la liste des attestations"""
        # Simulation - √Ä remplacer par requ√™te DB
        return []
    
    def verifier_conformite_projet(self, type_projet: str, valeur: float, ville: str) -> Dict:
        """V√©rifie la conformit√© pour un nouveau projet"""
        resultats = {
            "conforme": True,
            "details": []
        }
        
        # V√©rifier licence RBQ appropri√©e
        if type_projet == "R√©sidentiel unifamilial":
            resultats["details"].append({
                "element": "Licence RBQ",
                "status": "OK",
                "message": "Cat√©gorie 1.1 ou 1.2 valide"
            })
        
        # V√©rifier cautionnement suffisant
        if valeur > 25000:
            resultats["details"].append({
                "element": "Cautionnement",
                "status": "OK",
                "message": "Cautionnement suffisant pour la valeur du projet"
            })
        
        # V√©rifier attestations
        resultats["details"].append({
            "element": "Attestations fiscales",
            "status": "OK",
            "message": "Toutes les attestations sont valides"
        })
        
        return resultats
    
    def compter_licences_actives(self) -> int:
        """Compte le nombre de licences RBQ actives"""
        return 1  # Simulation
    
    def compter_cartes_valides(self) -> int:
        """Compte le nombre de cartes CCQ valides"""
        return 15  # Simulation
    
    def compter_attestations_valides(self) -> int:
        """Compte le nombre d'attestations valides"""
        return 5  # Simulation
    
    def calculer_score_conformite(self) -> int:
        """Calcule le score global de conformit√©"""
        return 92  # Simulation
    
    def obtenir_toutes_alertes(self) -> List[Dict]:
        """Obtient toutes les alertes de conformit√©"""
        return []  # Simulation
    
    def obtenir_prochains_renouvellements(self) -> List[Dict]:
        """Obtient la liste des prochains renouvellements"""
        return []  # Simulation